<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>–§–∏—Ç–Ω–µ—Å‚Äë—Ç—Ä–µ–∫–µ—Ä</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f7fa;  /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Å–µ—Ä—ã–π */
            color: #1e1e1e;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 12px;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî –∏–º–∏—Ç–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ iPhone 17 Pro Max */
        .phone-frame {
            max-width: 430px;  /* —Ç–∏–ø–∏—á–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –±–æ–ª—å—à–∏—Ö iPhone */
            width: 100%;
            background-color: #ffffff;
            border-radius: 44px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.12), 0 8px 20px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            padding: 20px 18px 30px 18px;
            position: relative;
            border: 1px solid #e9e9e9;
        }

        h1, h2 {
            font-size: 28px;
            font-weight: 620;
            letter-spacing: -0.3px;
            color: #1c1c1e;
            margin-bottom: 16px;
            padding-left: 4px;
        }

        /* ===== –ü–õ–ê–®–ö–ò –î–ù–ï–ô ===== */
        .days-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            margin-bottom: 28px;
        }

        .day-chip {
            flex: 1 1 0px;
            text-align: center;
            background-color: #f0f2f5;  /* —Å–≤–µ—Ç–ª—ã–π —Å–µ—Ä—ã–π */
            padding: 12px 0;
            border-radius: 20px;
            font-weight: 500;
            font-size: 16px;
            color: #2c2c2e;
            border: 1.5px solid transparent;
            transition: all 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            cursor: pointer;
            user-select: none;
        }

        .day-chip.current-day {
            border-color: #ff9500;  /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
            background-color: #fff1e0;
            color: #1c1c1e;
            font-weight: 600;
        }

        .day-chip.selected-day {
            background-color: #c4e1f6;  /* –≥–æ–ª—É–±–æ–π */
            color: #003458;
            border-color: #007aff;
        }

        /* ===== –°–ü–ò–°–û–ö –£–ü–†–ê–ñ–ù–ï–ù–ò–ô ===== */
        .exercises-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è */
        .exercise-card {
            background-color: #fafafc;
            border-radius: 24px;
            padding: 16px 18px;
            border: 1px solid #eceef0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.02);
            transition: 0.15s;
            cursor: grab;
            user-select: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        .exercise-card.dragging {
            opacity: 0.5;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            cursor: grabbing;
        }

        .card-main-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .exercise-title {
            font-size: 18px;
            font-weight: 590;
            color: #111;
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .set-badge {
            background-color: #e6e8ec;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 530;
            color: #1c1c1e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .set-badge .current-set {
            color: #ff6900; /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
            font-weight: 700;
        }

        .weight-reps-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            background-color: #ffffff;
            padding: 10px 14px;
            border-radius: 40px;
            border: 1px solid #e2e4e8;
            flex-wrap: wrap;
        }

        .weight-info, .reps-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rest-timer-area {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #d9eafb;  /* –≥–æ–ª—É–±–æ–π –æ—á–µ–Ω—å –±–ª–µ–¥–Ω—ã–π */
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 500;
            color: #00568f;
        }

        .play-pause-btn {
            background: none;
            border: none;
            font-size: 30px;
            line-height: 1;
            cursor: pointer;
            color: #007aff; /* –≥–æ–ª—É–±–æ–π */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #eef5fe;
            transition: 0.1s;
        }

        .play-pause-btn:active {
            background-color: #cde1fc;
        }

        .completed-mark {
            font-size: 24px;
            margin-left: 6px;
            color: #28a745;
        }

        /* –ü–ª–∞—à–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" */
        .add-exercise-card {
            background-color: #f2f4f8;
            border-radius: 24px;
            padding: 18px;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            color: #636366;
            border: 2px dashed #b0b3b8;
            cursor: pointer;
            transition: 0.1s;
            margin-bottom: 20px;
        }
        .add-exercise-card:active {
            background-color: #e2e5ea;
        }

        /* –ù–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
        .bottom-buttons {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            margin-top: 16px;
        }
        .nav-btn {
            flex: 1;
            background-color: #ffffff;
            border: 1.5px solid #d0d3d9;
            border-radius: 40px;
            padding: 16px 10px;
            font-size: 18px;
            font-weight: 590;
            color: #1c1c1e;
            cursor: pointer;
            text-align: center;
            transition: 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .nav-btn:active {
            background-color: #eef1f5;
        }

        /* –≠–∫—Ä–∞–Ω—ã (–≥–ª–∞–≤–Ω–∞—è/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏/–∏—Å—Ç–æ—Ä–∏—è) */
        .screen {
            display: block;
        }
        .hidden {
            display: none !important;
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-group {
            background-color: #fafafc;
            border-radius: 26px;
            padding: 18px;
            margin-bottom: 28px;
            border: 1px solid #ecedef;
        }
        .exercise-item-settings {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            background: white;
            border-radius: 30px;
            padding: 12px 14px;
            margin-bottom: 10px;
            border: 1px solid #dddfe3;
        }
        .exercise-item-settings input {
            border: 1px solid #c6c8cc;
            border-radius: 30px;
            padding: 10px 14px;
            font-size: 16px;
            background: white;
            width: 140px;
        }
        .counter-control {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f0f2f5;
            border-radius: 40px;
            padding: 4px 10px;
        }
        .counter-control button {
            width: 34px;
            height: 34px;
            border-radius: 30px;
            border: none;
            background: white;
            font-size: 22px;
            font-weight: 600;
            color: #1c1c1e;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .rest-timer-setting {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .export-import {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .gray-btn {
            background-color: #eef0f3;
            border: none;
            border-radius: 40px;
            padding: 16px 22px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-table {
            background: #f8f9fc;
            border-radius: 30px;
            padding: 12px;
            border: 1px solid #e1e4e8;
        }
        .history-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 12px;
            border-bottom: 1px solid #dee1e6;
        }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ */
        .timer-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="phone-frame" id="app">
    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="mainScreen" class="screen">
        <h1>–§–∏—Ç–Ω–µ—Å‚Äë—Ç—Ä–µ–∫–µ—Ä</h1>

        <!-- –ü–ª–∞—à–∫–∏ –¥–Ω–µ–π -->
        <div class="days-row" id="daysContainer"></div>

        <!-- –°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (draggable) -->
        <div class="exercises-container" id="exercisesList"></div>

        <!-- –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ -->
        <div class="add-exercise-card" id="addExerciseBtn">+ –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>

        <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="bottom-buttons">
            <button class="nav-btn" id="goToSettingsBtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="nav-btn" id="goToHistoryBtn">–ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="settingsScreen" class="screen hidden">
        <h2 style="margin-bottom: 8px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <button id="backFromSettings" style="background:none; border:none; font-size:20px; margin-bottom:12px;">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="settings-group" id="exercisesSettingsList"></div>

        <div class="rest-timer-setting">
            <span style="font-weight:500;">–¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ (—Å–µ–∫):</span>
            <input type="number" id="globalRestSeconds" value="60" min="5" max="300" step="5" style="width:80px; border-radius:30px; padding:8px; border:1px solid #aaa;">
        </div>

        <div class="export-import">
            <button class="gray-btn" id="exportHistory">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
            <button class="gray-btn" id="importHistory">üì• –ò–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
        </div>
        <p style="color:gray; font-size:14px; margin-top:16px;">* –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ò—Å—Ç–æ—Ä–∏—è -->
    <div id="historyScreen" class="screen hidden">
        <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
        <button id="backFromHistory" style="background:none; border:none; font-size:20px; margin-bottom:12px;">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="history-table" id="historyLog"></div>
    </div>
</div>

<script>
    (function() {
        // ----- –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö (LocalStorage) -----
        const STORAGE_KEYS = {
            EXERCISES: 'fit_exercises_library',   // –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            WORKOUTS: 'fit_workouts_data',        // —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–Ω—è–º
            HISTORY: 'fit_history',                // –∏—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π
            REST_SEC: 'fit_rest_seconds'
        };

        // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        let exerciseLibrary = [
            { id: 'e1', name: '–ñ–∏–º –ª—ë–∂–∞', weight: 50.0, sets: 3, reps: 10 },
            { id: 'e2', name: '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', weight: 60.0, sets: 4, reps: 12 },
            { id: 'e3', name: '–¢—è–≥–∞ –≤–µ—Ä—Ö', weight: 40.0, sets: 3, reps: 8 },
        ];

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –¥–Ω—è–º (7 –¥–Ω–µ–π, –∏–Ω–¥–µ–∫—Å—ã 0-6 = –ø–Ω-–≤—Å)
        let workouts = [
            [], // –ø–Ω
            [], // –≤—Ç
            [], // —Å—Ä
            [], // —á—Ç
            [], // –ø—Ç
            [], // —Å–±
            []  // –≤—Å
        ];

        // –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π { date, dayIndex, exerciseName, weight, sets, reps, completedAt }
        let historyLog = [];

        let restSecondsDefault = 60; // —Å–µ–∫—É–Ω–¥

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
        function loadAllData() {
            try {
                const lib = localStorage.getItem(STORAGE_KEYS.EXERCISES);
                if (lib) exerciseLibrary = JSON.parse(lib);

                const wk = localStorage.getItem(STORAGE_KEYS.WORKOUTS);
                if (wk) workouts = JSON.parse(wk);
                else initializeWorkoutsFromLibrary(); // –Ω–∞—á–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

                const hist = localStorage.getItem(STORAGE_KEYS.HISTORY);
                if (hist) historyLog = JSON.parse(hist);

                const rest = localStorage.getItem(STORAGE_KEYS.REST_SEC);
                if (rest) restSecondsDefault = parseInt(rest, 10);
            } catch (e) { console.warn("Load error", e); }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ–≥–æ
        function saveAll() {
            localStorage.setItem(STORAGE_KEYS.EXERCISES, JSON.stringify(exerciseLibrary));
            localStorage.setItem(STORAGE_KEYS.WORKOUTS, JSON.stringify(workouts));
            localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(historyLog));
            localStorage.setItem(STORAGE_KEYS.REST_SEC, restSecondsDefault);
        }

        // –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å–æ–∑–¥–∞—ë–º –¥–µ–º–æ-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        function initializeWorkoutsFromLibrary() {
            if (workouts.every(day => day.length === 0)) {
                workouts[0] = exerciseLibrary.map(ex => ({
                    ...ex,
                    id: crypto.randomUUID ? crypto.randomUUID() : 'id-'+Date.now()+Math.random(),
                    completedSets: 0,
                    isCompleted: false,
                    restEndTime: null,
                    timerPaused: false
                }));
            }
        }

        loadAllData();
        if (!workouts[0] || workouts[0].length === 0) initializeWorkoutsFromLibrary();

        // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI
        let currentDayIndex = new Date().getDay(); // 0 –≤—Å,1 –ø–Ω ... 6 —Å–± ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º
        if (currentDayIndex === 0) currentDayIndex = 6; // –≤—Å -> –∏–Ω–¥–µ–∫—Å 6
        else currentDayIndex = currentDayIndex - 1; // –ø–Ω=0, –≤—Ç=1 ...

        let selectedDayIndex = currentDayIndex; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å

        // –¢–∞–π–º–µ—Ä—ã
        let timers = {}; // id —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -> –∏–Ω—Ç–µ—Ä–≤–∞–ª

        // ----- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -----
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        function renderMain() {
            renderDays();
            renderExercises();
        }

        function renderDays() {
            const days = ['–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±', '–≤—Å'];
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';
            days.forEach((day, idx) => {
                const chip = document.createElement('div');
                chip.classList.add('day-chip');
                chip.textContent = day;
                if (idx === currentDayIndex) chip.classList.add('current-day');
                if (idx === selectedDayIndex) chip.classList.add('selected-day');
                chip.addEventListener('click', () => {
                    selectedDayIndex = idx;
                    renderDays();
                    renderExercises();
                });
                container.appendChild(chip);
            });
        }

        function renderExercises() {
            const container = document.getElementById('exercisesList');
            container.innerHTML = '';
            const dayWorkouts = workouts[selectedDayIndex] || [];
            dayWorkouts.forEach((ex, index) => {
                const card = document.createElement('div');
                card.classList.add('exercise-card');
                card.setAttribute('draggable', 'true');
                card.dataset.index = index;
                card.dataset.id = ex.id;

                // –õ–æ–≥–∏–∫–∞ completed
                const allSetsDone = ex.completedSets >= ex.sets;
                if (allSetsDone) card.style.backgroundColor = '#e6f2e6';

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –≤–µ—Å/–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                const mainRow = document.createElement('div');
                mainRow.className = 'card-main-row';
                mainRow.innerHTML = `
                    <span class="exercise-title">${ex.name}</span>
                    <span class="set-badge"><span class="current-set">${ex.completedSets || 0}</span>/${ex.sets}</span>
                `;

                const weightReps = document.createElement('div');
                weightReps.className = 'weight-reps-row';
                weightReps.innerHTML = `
                    <span class="weight-info">‚öñÔ∏è ${ex.weight} –∫–≥</span>
                    <span class="reps-info">üîÅ ${ex.reps} –ø–æ–≤—Ç.</span>
                `;

                // –ö–Ω–æ–ø–∫–∞ Play/Pause –∏ –∑–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞/—Ç–∞–π–º–µ—Ä–∞
                const controls = document.createElement('div');
                controls.style.display = 'flex';
                controls.style.alignItems = 'center';
                controls.style.justifyContent = 'space-between';

                const btn = document.createElement('button');
                btn.className = 'play-pause-btn';
                const isPaused = ex.restEndTime && new Date().getTime() < ex.restEndTime;
                const isResting = isPaused && !ex.timerPaused; // —É–ø—Ä–æ—â—ë–Ω–Ω–æ
                if (ex.completedSets >= ex.sets) {
                    btn.innerHTML = '‚úÖ';
                    btn.disabled = true;
                } else if (ex.restEndTime && new Date().getTime() < ex.restEndTime) {
                    btn.innerHTML = '‚è∏Ô∏è'; // –ø–∞—É–∑–∞
                } else {
                    btn.innerHTML = '‚ñ∂Ô∏è';
                }

                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handlePlayPause(ex.id);
                });

                controls.appendChild(btn);

                const restArea = document.createElement('div');
                restArea.className = 'rest-timer-area';
                if (ex.restEndTime && new Date().getTime() < ex.restEndTime) {
                    const remain = Math.max(0, Math.floor((ex.restEndTime - new Date().getTime())/1000));
                    restArea.innerHTML = `–û—Ç–¥—ã—Ö <span class="timer-value">${formatTime(remain)}</span>`;
                } else if (ex.completedSets < ex.sets && ex.completedSets > 0 && !ex.restEndTime) {
                    // –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                }
                if (restArea.innerHTML !== '') controls.appendChild(restArea);

                card.appendChild(mainRow);
                card.appendChild(weightReps);
                card.appendChild(controls);

                // drag & drop
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);

                container.appendChild(card);
            });
        }

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
        let dragSrcIndex = null;
        function handleDragStart(e) {
            dragSrcIndex = e.target.closest('.exercise-card')?.dataset.index;
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragEnd(e) { }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDrop(e) {
            e.preventDefault();
            const targetCard = e.target.closest('.exercise-card');
            if (!targetCard) return;
            const dragIndex = parseInt(dragSrcIndex, 10);
            const dropIndex = parseInt(targetCard.dataset.index, 10);
            if (dragIndex === dropIndex) return;

            const dayExercises = workouts[selectedDayIndex];
            if (!dayExercises) return;
            const [removed] = dayExercises.splice(dragIndex, 1);
            dayExercises.splice(dropIndex, 0, removed);
            saveAll();
            renderExercises();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ play/pause
        function handlePlayPause(exId) {
            const day = workouts[selectedDayIndex];
            const ex = day.find(e => e.id === exId);
            if (!ex || ex.completedSets >= ex.sets) return;

            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–µ–Ω —Ç–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞
            if (ex.restEndTime && new Date().getTime() < ex.restEndTime) {
                // –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ pause -> —Å–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ (–¥–æ—Å—Ä–æ—á–Ω–æ)
                if (timers[exId]) clearInterval(timers[exId]);
                ex.restEndTime = null;
                saveAll();
                renderExercises();
                return;
            }

            // –ò–Ω–∞—á–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥—Ö–æ–¥: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º completedSets
            if (!ex.completedSets) ex.completedSets = 0;
            ex.completedSets += 1;

            // –ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã
            if (ex.completedSets >= ex.sets) {
                // –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                historyLog.push({
                    date: new Date().toLocaleString(),
                    dayIndex: selectedDayIndex,
                    exerciseName: ex.name,
                    weight: ex.weight,
                    sets: ex.sets,
                    reps: ex.reps,
                    completedAt: new Date().toISOString()
                });
                ex.restEndTime = null;
                if (timers[exId]) clearInterval(timers[exId]);
                saveAll();
                renderExercises();
                return;
            }

            // –ò–Ω–∞—á–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ (restSecondsDefault)
            const restSec = restSecondsDefault;
            const endTime = new Date().getTime() + restSec * 1000;
            ex.restEndTime = endTime;

            if (timers[exId]) clearInterval(timers[exId]);
            timers[exId] = setInterval(() => {
                if (!ex.restEndTime) {
                    clearInterval(timers[exId]);
                    delete timers[exId];
                    return;
                }
                const now = new Date().getTime();
                if (now >= ex.restEndTime) {
                    ex.restEndTime = null;
                    clearInterval(timers[exId]);
                    delete timers[exId];
                }
                renderExercises();
            }, 200);

            saveAll();
            renderExercises();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        document.getElementById('addExerciseBtn').addEventListener('click', () => {
            if (exerciseLibrary.length === 0) return;
            // –°–æ–∑–¥–∞—ë–º –∫–æ–ø–∏—é –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ, –ª—É—á—à–µ –≤—ã–±—Ä–∞—Ç—å —á–µ—Ä–µ–∑ prompt)
            const libItem = exerciseLibrary[0];
            const newEx = {
                ...libItem,
                id: crypto.randomUUID ? crypto.randomUUID() : 'id-'+Date.now(),
                completedSets: 0,
                restEndTime: null
            };
            workouts[selectedDayIndex].push(newEx);
            saveAll();
            renderExercises();
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        document.getElementById('goToSettingsBtn').addEventListener('click', () => {
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('settingsScreen').classList.remove('hidden');
            renderSettings();
        });
        document.getElementById('goToHistoryBtn').addEventListener('click', () => {
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('historyScreen').classList.remove('hidden');
            renderHistory();
        });
        document.getElementById('backFromSettings').addEventListener('click', () => {
            document.getElementById('settingsScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            renderMain();
        });
        document.getElementById('backFromHistory').addEventListener('click', () => {
            document.getElementById('historyScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            renderMain();
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        function renderSettings() {
            const container = document.getElementById('exercisesSettingsList');
            container.innerHTML = '';
            exerciseLibrary.forEach((ex, idx) => {
                const div = document.createElement('div');
                div.className = 'exercise-item-settings';
                div.innerHTML = `
                    <input type="text" value="${ex.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" data-idx="${idx}" data-field="name">
                    <div class="counter-control">
                        <button data-idx="${idx}" data-field="weight" data-delta="-0.5">‚àí</button>
                        <span>${ex.weight} –∫–≥</span>
                        <button data-idx="${idx}" data-field="weight" data-delta="0.5">+</button>
                    </div>
                    <div class="counter-control">
                        <button data-idx="${idx}" data-field="sets" data-delta="-1">‚àí</button>
                        <span>${ex.sets} —Å–µ—Ç</span>
                        <button data-idx="${idx}" data-field="sets" data-delta="1">+</button>
                    </div>
                    <div class="counter-control">
                        <button data-idx="${idx}" data-field="reps" data-delta="-1">‚àí</button>
                        <span>${ex.reps} –ø–æ–≤—Ç</span>
                        <button data-idx="${idx}" data-field="reps" data-delta="1">+</button>
                    </div>
                `;
                container.appendChild(div);
            });

            // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.counter-control button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = e.target.dataset.idx;
                    const field = e.target.dataset.field;
                    const delta = parseFloat(e.target.dataset.delta);
                    if (exerciseLibrary[idx]) {
                        if (field === 'weight') exerciseLibrary[idx].weight = Math.max(0, exerciseLibrary[idx].weight + delta);
                        if (field === 'sets') exerciseLibrary[idx].sets = Math.max(1, exerciseLibrary[idx].sets + delta);
                        if (field === 'reps') exerciseLibrary[idx].reps = Math.max(1, exerciseLibrary[idx].reps + delta);
                        saveAll();
                        renderSettings();
                    }
                });
            });

            // –∏–Ω–ø—É—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π
            document.querySelectorAll('.exercise-item-settings input').forEach(inp => {
                inp.addEventListener('change', (e) => {
                    const idx = e.target.dataset.idx;
                    exerciseLibrary[idx].name = e.target.value;
                    saveAll();
                });
            });

            // —Ç–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞
            const restInput = document.getElementById('globalRestSeconds');
            restInput.value = restSecondsDefault;
            restInput.addEventListener('change', (e) => {
                restSecondsDefault = parseInt(e.target.value, 10) || 60;
                saveAll();
            });
        }

        // –ò—Å—Ç–æ—Ä–∏—è
        function renderHistory() {
            const cont = document.getElementById('historyLog');
            cont.innerHTML = historyLog.length === 0 ? '<div class="history-row">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>' : '';
            historyLog.slice().reverse().forEach(entry => {
                const row = document.createElement('div');
                row.className = 'history-row';
                row.innerHTML = `<span>${entry.exerciseName} ${entry.weight}–∫–≥ ${entry.sets}x${entry.reps}</span><span style="color:gray;">${new Date(entry.completedAt).toLocaleDateString()}</span>`;
                cont.appendChild(row);
            });
        }

        // –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç
        document.getElementById('exportHistory').addEventListener('click', () => {
            const dataStr = JSON.stringify(historyLog);
            navigator.clipboard.writeText(dataStr).then(() => alert('–ò—Å—Ç–æ—Ä–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä'));
        });
        document.getElementById('importHistory').addEventListener('click', () => {
            const data = prompt('–í—Å—Ç–∞–≤—å—Ç–µ JSON –∏—Å—Ç–æ—Ä–∏–∏');
            try {
                if (data) {
                    historyLog = JSON.parse(data);
                    saveAll();
                    alert('–ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞');
                }
            } catch { alert('–û—à–∏–±–∫–∞'); }
        });

        // –°—Ç–∞—Ä—Ç
        renderMain();
    })();
</script>
</body>
</html>